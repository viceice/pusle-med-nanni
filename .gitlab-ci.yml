stages:
  - build
  - deploy

.deploy:
  interruptible: true
  image: registry.kriese.eu/jobs/docker/base@sha256:e395c0c111d5d13f40e077c14cc1ddca3bfce328f87f7cf3c77018be3bb3b68d
  stage: deploy
  before_script:
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  script:
    - rsync -aPhh --chmod=D775,F664 --delete ./dist/ --exclude-from=.rsyncignore gitlab@vps577063.ovh.net:/opt/docker/html/de.pusle-med-nanni.${CI_ENVIRONMENT_SLUG}/
  only:
    - master

build:
  interruptible: true
  stage: build
  image: ghcr.io/visualon/node:14.15.1@sha256:e7c4e41c3204c9e41d1dbcd158f122a8c5528ed33720bd229e40a243d5d5957d
  variables:
    YARN_CACHE_FOLDER: '.yarn-cache'
  cache:
    key: ${CI_COMMIT_REF_SLUG}-build
    paths:
      - node_modules/
      - .yarn-cache
      - dist/
  before_script:
    - apk add --no-cache graphicsmagick git
    - yarn install --frozen-lockfile
  script:
    - yarn build
    - find dist/images/ -type f -iname '*.jpg' -not -name '*.thumb*' -delete
  artifacts:
    paths:
      - dist

deploy_dev:
  extends: .deploy
  environment:
    name: dev
    url: https://dev.pusle-med-nanni.de

deploy_prod:
  extends: .deploy
  environment:
    name: www
    url: https://www.pusle-med-nanni.de
  when: manual

pages:
  stage: deploy
  script:
    - mv dist public
  artifacts:
    paths:
      - public
  when: manual
  only:
    - master
